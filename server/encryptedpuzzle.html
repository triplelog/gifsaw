<!DOCTYPE html>

	
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gifsaw</title>
<meta name="description" content="."/>

<style>
:root {
	--block-width: 17px;
	--side-height: 33;
	--top-width: 27;
}

img {
	position: absolute;
	left: 50px;
	top: 50px;
}
{% for i in range(0,npieces) %}
	#video{{ i+1 }} {
	-webkit-clip-path:url(#clip{{ i+1 }});
	clip-path:url(#clip{{ i+1 }});
}
{% endfor %}


#playbutton {
	position: absolute;
	left: 0px;
	top: 0px;
}
#rotatebutton {
	position: absolute;
	left: 50px;
	top: 0px;
}
#pointsspan {
	position: absolute;
	left: 0px;
	top: 0px;
}
img {
	display: block;
	width: calc(<%= image.width %> * 1.5px);
	height: auto;
	background: rgba(255,255,255,1);
}

#progressdiv {
	position: absolute;
	left: 0px;
	top: 0px;
}
</style>

</head>
<body>

<svg width="960" height="448" viewBox = "0 0 960 448" version = "1.1">
    <defs>
    	
    	<% for (var i=0;i< npieces ;i++) { %>
    	  <clipPath id="clip<%= i+1 %>" clipPathUnits="objectBoundingBox">
			<path id="path<%= i+1 %>" d="M<%= vlines[i][0] %><%= hlines[i][0] %><%= vlines[i][1] %><%= hlines[i][1] %>" />
		  </clipPath>
		<% } %>
    	
    	  
    </defs>
</svg>

<% for (var i=1;i< npieces+1 ;i++) { %>
    <!--<img id="video<%= i %>" src="<%= image.name %>">-->
    <img id="video<%= i %>" src="../gifs/optdodgers.gif">
<% } %>



	


<!--<button id="playbutton" onclick="playvideo()">Play</button>-->
<!--<button id="rotatebutton" onclick="rotate()">Rotate</button>-->

<div id="scorediv"></div>
<progress id="progressdiv" class="progress" value="15" max="100">15%</progress>
<button id="save" href="">Save</button>

<script>

var dragid;
var isclick = true;
var startX;
var startY;
var cvideo;
var vmatches;
var nmatches;
var videos = {};
var score = {};
var myname;
var gifwidth = <%= image.width %>;
var gifheight = <%= image.height %>;
var npieces= <%= npieces %>;
var locations= <%= locations %>;
var rotations= <%= rotations %>;
var matches= <%- matches %>;
var centers= <%= centers %>;
var saveButton = document.getElementById('save');
var cwidth = 512*1.5;
var cheight = 512*1.5*328/(276*2+512);
var hclines = <%- hclines %>;
var vclines = <%- vclines %>;
var ccenters= <%= ccenters %>;

for (var i=1;i<npieces+1;i++) {
	var video = document.getElementById('video'+i);
	
	video.addEventListener('mousedown',dragstart);
	
	video.style.left = locations[i-1][0]+'px';
	video.style.top = locations[i-1][1]+'px';
	video.style.transform = 'rotate('+rotations[i-1]+'deg)';
	video.style.transformOrigin = centers[i-1][0][0]*100+'% '+centers[i-1][0][1]*100+'%';
	//video.style.display = 'none';
	videos['video'+i] = video;
	
	
}

function throttled(delay, fn) {
  let lastCall = 0;
  return function (...args) {
    const now = (new Date).getTime();
    if (now - lastCall < delay || !dragid || dragid.length<5) {
      return;
    }
    lastCall = now;
    return fn(...args);
  }
}
const tHandler = throttled(40, dragmove);
document.addEventListener('mousemove',tHandler);
document.addEventListener('mouseup',dragend);



function dragstart(event) {
	event.preventDefault();
	e = event || window.event;
	
	if (!dragid || dragid == ''){
		dragid = e.target.id;
		cvideo = videos[dragid];
		if (cvideo) {
			vmatches = [];
			nmatches = 0;
			startX = [e.pageX,parseFloat(cvideo.style.left)];
			startY = [e.pageY,parseFloat(cvideo.style.top)];
			for (var i=1;i<npieces+1;i++) {
				let tempkey = 'video'+i;
				
				if (document.getElementById(tempkey) && tempkey != dragid){
					let tempvideo = videos[tempkey].getBoundingClientRect();
					for (var ii=0;ii<centers[i-1].length;ii++){
						vmatches.push([tempkey,[parseFloat(tempvideo.left)+centers[i-1][ii][0]*parseFloat(cwidth),parseFloat(tempvideo.top)+centers[i-1][ii][1]*parseFloat(cheight)]]);
						nmatches++;
					}
				}
			}
		}
	}
	
}

function dragmove(event) {
	e = event || window.event;

	if (dragid && dragid.length > 5) {
		let newLeft = e.pageX;
		let newTop = e.pageY;
		if ((newLeft < startX[0]-0 || newLeft > startX[0]+0) && (newTop < startY[0]-0 || newTop > startY[0]+0)){
			cvideo.style.left = e.pageX - startX[0] + startX[1] + 'px';
			cvideo.style.top = e.pageY - startY[0] + startY[1] + 'px';
			startX[1] += newLeft - startX[0];
			startY[1] += newTop- startY[0];
			startX[0] = newLeft;
			startY[0] = newTop;
			isclick = false;
		}
		else if (newLeft < startX[0]-0 || newLeft > startX[0]+0){
			cvideo.style.left = e.pageX - startX[0] + startX[1] + 'px';
			startX[1] += newLeft - startX[0];
			startX[0] = newLeft;
			isclick = false;
		}
		else if (newTop < startY[0]-0 || newTop > startY[0]+0){
			cvideo.style.top = e.pageY - startY[0] + startY[1] + 'px';
			startY[1] += newTop - startY[0];
			startY[0] = newTop;
			isclick = false;
		}
	}
	

}
function dragend() {
	if (isclick && dragid && dragid != '') {
		var drid = dragid;
		document.getElementById(drid).style.transform = 'rotate('+(parseInt(rotations[parseInt(drid.substr(5,))-1])+90)+'deg)';
		rotations[parseInt(drid.substr(5,))-1]=(parseInt(rotations[parseInt(drid.substr(5,))-1])+90);
		if (rotations[parseInt(drid.substr(5,))-1]> 350) {
			rotations[parseInt(drid.substr(5,))-1] = rotations[parseInt(drid.substr(5,))-1]-360;
		}
	}
	else if (dragid && dragid != '') {
		var pieceheight = cheight*144/164/4;
		var piecewidth = pieceheight*512/288*4/6;
		var possMatches = {};
		possMatches[parseInt(dragid.substr(5,))]=[];
		for (var ii=0;ii<centers[parseInt(dragid.substr(5,))-1].length;ii++) {
			let newx = parseFloat(cvideo.getBoundingClientRect().left)+centers[parseInt(dragid.substr(5,))-1][ii][0]*parseFloat(cwidth);
			let newy = parseFloat(cvideo.getBoundingClientRect().top)+centers[parseInt(dragid.substr(5,))-1][ii][1]*parseFloat(cheight);
		
			for (var i=0;i<nmatches;i++) {
				var possMatch = false;
				let tempkey = parseInt(vmatches[i][0].substr(5,))-1;
				let tempbox = vmatches[i][1];

				if (rotations[parseInt(dragid.substr(5,))-1]==rotations[tempkey]) {
					if (newx < tempbox[0] + piecewidth + 10 && newy < tempbox[1] + pieceheight + 10) {
						if (newx > tempbox[0] + piecewidth - 10) {
							//in far right match zone
						
							if (newy > tempbox[1] - 10 && newy < tempbox[1] + 10) {
								possMatch = 'right';
							}
						
						}
						else if (newx > tempbox[0] - piecewidth - 10 && newx < tempbox[0] - piecewidth + 10) {
							//in far left match zone
						
							if (newy > tempbox[1] - 10 && newy < tempbox[1] + 10) {
								possMatch = 'left';
							}
						}
						else if (newx > tempbox[0] - 10 && newx < tempbox[0] + 10) {
							//in center match zone
							if (newy > tempbox[1] + pieceheight - 10) {
								possMatch = 'bottom';
							}
							else if (newy > tempbox[1] - pieceheight - 10 && newy < tempbox[1] - pieceheight + 10) {
								possMatch = 'top';
							}
						}
				
					}
				}
				if (possMatch) {
					var skipMatch = false;
					for (var iii=0;iii<possMatches[parseInt(dragid.substr(5,))].length;iii++) {
						if (possMatches[parseInt(dragid.substr(5,))][iii][0]==tempkey+1 && possMatches[parseInt(dragid.substr(5,))][iii][1]==possMatch){
							skipMatch = true;
							break;
						}
					}
					if (!skipMatch){
						possMatches[parseInt(dragid.substr(5,))].push([tempkey+1,possMatch]);
					}
				}
			}
		}			
		
		if (possMatches[parseInt(dragid.substr(5,))].length>0){
			socketanswer(parseInt(dragid.substr(5,)),possMatches[parseInt(dragid.substr(5,))]);
		}
		
	}
	dragid = '';
	isclick = true;
	
}
function playvideo() {
	for (var i=1;i<npieces+1;i++) {
		var video = videos['video'+i];
		if (video){video.style.display = 'inline-block';}
	}
}
function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}


</script>
<% if (gametype == 'collab') { %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script>

var socket = false;
var keepscore = false;
if (getUrlVars()['type'] && getUrlVars()['type']=='solo') {
	
}
else {
	socket = io.connect('', {query: 'name=<%= pagename %>&username=anonuser'});
}
</script>
<script src="../js/collabpuzzle.js"></script>
<script src="../js/solopuzzle.js"></script>

<% } else if (gametype == 'comp' && players != 'multiple') { %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script>var socket = io.connect('', {query: 'name=<%= pagename %>'}); var keepscore = true; var keeppoints = <%= score %>;</script>
<script src="../js/collabpuzzle.js"></script>
<script src="../js/solopuzzle.js"></script>

<% } else if (gametype == 'comp' && players == 'multiple') { %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

<script>var socket = io.connect('', {query: 'name=<%= pagename %>'+getUrlVars()['user']}); console.log('name=<%= pagename %>'+getUrlVars()['user']); var keepscore = false;</script>
<script src="../js/collabpuzzle.js"></script>
<script src="../js/solopuzzle.js"></script>

<% } else { %>

<script>
function gameOver() {
	console.log('Congrats');
}
</script>
<script>var socket = false; var keepscore = false;</script>
<script src="../js/solopuzzle.js"></script>

<% } %>

</body>

	</html>





