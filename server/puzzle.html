<!DOCTYPE html>

	
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Demographics</title>
<link rel="icon" href="http://localhost:1313/">
<meta name="description" content="Complete a sudoku puzzle without Javascript or server-side interaction."/>

<style>
:root {
	--block-width: 17px;
	--side-height: 33;
	--top-width: 27;
}

img {
	position: absolute;
	left: 50px;
	top: 50px;
}

{% for i in range(0,npieces) %}
#video{{ i+1 }} {
	-webkit-clip-path:url(#clip{{ i+1 }});
	clip-path:url(#clip{{ i+1 }});
}
{% endfor %}


#playbutton {
	position: absolute;
	left: 0px;
	top: 0px;
}
#rotatebutton {
	position: absolute;
	left: 50px;
	top: 0px;
}
#pointsspan {
	position: absolute;
	left: 0px;
	top: 0px;
}
img {
	display: block;
	width: calc({{ image.width }} * 1.5px);
	height: auto;
	background: rgba(255,255,255,1);
}
#progressdiv {
	position: absolute;
	left: 0px;
	top: 0px;
}
</style>

</head>
<body>

<svg width="960" height="448" viewBox = "0 0 960 448" version = "1.1">
    <defs>
		{% for i in range(0,npieces)  %}
    	  <clipPath id="clip{{ i+1 }}" clipPathUnits="objectBoundingBox">
			<path id="path{{ i+1 }}" d="M{{ vlines[i][0] }}{{ hlines[i][0] }}{{ vlines[i][1] }}{{ hlines[i][1] }}" />
		  </clipPath>
		{% endfor %}
    </defs>
</svg>


{% for i in range(0,npieces)  %}
    <img id="video{{ i+1 }}" src="{{ image.name }}">
{% endfor %}

	


<!--<button id="playbutton" onclick="playvideo()">Play</button>-->
<!--<button id="rotatebutton" onclick="rotate()">Rotate</button>-->

<div id="scorediv"></div>
<progress id="progressdiv" class="progress" value="15" max="100">15%</progress>
<button id="save" href="">Save</button>

<script>

var dragid;
var isclick = true;
var startX;
var startY;
var cvideo;
var vmatches;
var nmatches;
var videos = {};
var score = {};
var myname;
var gifwidth = {{ image.width }};
var gifheight = {{ image.height }};
var npieces= {{ npieces }};
var matches= {{ matches | dump | safe }};
var locations= {{ locations }};
var rotations= {{ rotations }};
var centers= {{ centers }};
var saveButton = document.getElementById('save');

for (var i=1;i<npieces+1;i++) {
	var video = document.getElementById('video'+i);
	
	video.addEventListener('mousedown',dragstart);
	
	video.style.left = locations[i-1][0]+'px';
	video.style.top = locations[i-1][1]+'px';
	video.style.transform = 'rotate('+rotations[i-1]+'deg)';
	video.style.transformOrigin = centers[i-1][0]*100+'% '+centers[i-1][1]*100+'%';
	//video.style.display = 'none';
	videos['video'+i] = video;
	
}

function throttled(delay, fn) {
  let lastCall = 0;
  return function (...args) {
    const now = (new Date).getTime();
    if (now - lastCall < delay || !dragid || dragid.length<5) {
      return;
    }
    lastCall = now;
    return fn(...args);
  }
}
const tHandler = throttled(40, dragmove);
document.addEventListener('mousemove',tHandler);
document.addEventListener('mouseup',dragend);



function dragstart(event) {
	event.preventDefault();
	e = event || window.event;
	
	if (!dragid || dragid == ''){
		dragid = e.target.id;
		cvideo = videos[dragid];
		if (cvideo) {
			vmatches = {};
			nmatches = matches[dragid].length;
			startX = [e.pageX,parseFloat(cvideo.style.left)];
			startY = [e.pageY,parseFloat(cvideo.style.top)];
			for (var i=0;i<nmatches;i++) {
				let tempkey = matches[dragid][i];
				let tempvideo = videos[tempkey].getBoundingClientRect();
				vmatches[tempkey]=[tempvideo.left,tempvideo.top];
			}
		}
	}
	
}

function dragmove(event) {
	e = event || window.event;

	if (dragid && dragid.length > 5) {
		let newLeft = e.pageX;
		let newTop = e.pageY;
		if ((newLeft < startX[0]-0 || newLeft > startX[0]+0) && (newTop < startY[0]-0 || newTop > startY[0]+0)){
			cvideo.style.left = e.pageX - startX[0] + startX[1] + 'px';
			cvideo.style.top = e.pageY - startY[0] + startY[1] + 'px';
			startX[1] += newLeft - startX[0];
			startY[1] += newTop- startY[0];
			startX[0] = newLeft;
			startY[0] = newTop;
			isclick = false;
		}
		else if (newLeft < startX[0]-0 || newLeft > startX[0]+0){
			cvideo.style.left = e.pageX - startX[0] + startX[1] + 'px';
			startX[1] += newLeft - startX[0];
			startX[0] = newLeft;
			isclick = false;
		}
		else if (newTop < startY[0]-0 || newTop > startY[0]+0){
			cvideo.style.top = e.pageY - startY[0] + startY[1] + 'px';
			startY[1] += newTop - startY[0];
			startY[0] = newTop;
			isclick = false;
		}
	}
	

}
function dragend() {
	if (isclick && dragid && dragid != '') {
		var drid = dragid;
		document.getElementById(drid).style.transform = 'rotate('+(parseInt(rotations[parseInt(drid.substr(5,))-1])+90)+'deg)';
		rotations[parseInt(drid.substr(5,))-1]=(parseInt(rotations[parseInt(drid.substr(5,))-1])+90);
		if (rotations[parseInt(drid.substr(5,))-1]> 350) {
			rotations[parseInt(drid.substr(5,))-1] = rotations[parseInt(drid.substr(5,))-1]-360;
		}
	}
	else if (dragid && dragid != '') {
		let newx = cvideo.getBoundingClientRect().left;
		let newy = cvideo.getBoundingClientRect().top;
		var stillmatch = true;
		while (stillmatch) {
			stillmatch = false;
			for (var i=0;i<nmatches;i++) {
				let tempbox = vmatches[matches[dragid][i]];
				if (rotations[parseInt(dragid.substr(5,))-1]==rotations[parseInt(matches[dragid][i].substr(5,))-1]) {
					if ( newx < parseFloat(tempbox[0])+20 && newx > parseFloat(tempbox[0])-20 && newy < parseFloat(tempbox[1])+20 && newy > parseFloat(tempbox[1])-20){
						if ( Math.pow(newx - parseFloat(tempbox[0]),2) + Math.pow(newy - parseFloat(tempbox[1]),2) < 400.0){
							mergepieces(dragid,matches[dragid][i],i);
							stillmatch = true;
							break;
						}
					}
				}
			}
		}
		
	}
	dragid = '';
	isclick = true;
	
}
function playvideo() {
	for (var i=1;i<npieces+1;i++) {
		var video = videos['video'+i];
		if (video){video.style.display = 'inline-block';}
	}
}
function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}


</script>
{% if (gametype == 'collab') %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script>

var socket = false;
var keepscore = false;
if (getUrlVars()['type'] && getUrlVars()['type']=='solo') {
	
}
else {
	socket = io.connect('', {query: 'name={{ pagename }}&username=anonuser'});
}
</script>
<script src="../js/collabpuzzle.js"></script>
<script src="../js/solopuzzle.js"></script>

{% elif (gametype == 'comp' && players != 'multiple') %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script>var socket = io.connect('', {query: 'name={{ pagename }}'}); var keepscore = true; var keeppoints = {{ score }};</script>
<script src="../js/collabpuzzle.js"></script>
<script src="../js/solopuzzle.js"></script>

{% elif (gametype == 'comp' && players == 'multiple') %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

<script>var socket = io.connect('', {query: 'name={{ pagename }}'+getUrlVars()['user']}); console.log('name={{ pagename }}'+getUrlVars()['user']); var keepscore = false;</script>
<script src="../js/collabpuzzle.js"></script>
<script src="../js/solopuzzle.js"></script>

{% else %}

<script>
function gameOver() {
	console.log('Congrats');
}
</script>
<script>var socket = false; var keepscore = false;</script>
<script src="../js/solopuzzle.js"></script>

{% endif %}

</body>

	</html>





